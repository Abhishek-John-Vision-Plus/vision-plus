// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String             @id @default(uuid())
  name          String
  email         String             @unique
  empId         String             @unique
  password      String
  process       String
  phone         String? // ✅ new column
  role          String             @default("USER") // ✅ new column
  createdAt     DateTime           @default(now())
  questionCount Int                @default(15) // ✅ new column: number of questions user must answer
  details       UserDetails?
  assessments   AssessmentResult[]
  assigned      AssignedQuestion[]
  examSessions  ExamSession[]
}

model TopicRule {
  id              String   @id @default(uuid())
  process         String   // The exam name/process (e.g., "PROCESS_A")
  category        String   // The topic name
  minAttempt      Int      @default(0)
  maxDisplay      Int      @default(0)
  requiredAttempt Int?     // If set, must answer exactly this many
  order           Int      @default(0) // Control the sequence of modules
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([process, category])
}

model ExamSession {
  id            String             @id @default(uuid())
  userId        String
  user          User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  process       String
  status        String             @default("ACTIVE") // ACTIVE, COMPLETED, EXPIRED
  startTime     DateTime           @default(now())
  endTime       DateTime?
  rulesSnapshot Json               // Snapshotted rules for this session
  questions     SessionQuestion[]
  answers       SessionAnswer[]
  
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  @@index([userId, status])
}

model SessionQuestion {
  id        String      @id @default(uuid())
  sessionId String
  session   ExamSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  mcqId     String
  mcq       Mcq         @relation(fields: [mcqId], references: [id], onDelete: Cascade)
  order     Int         // Fixed order for this session
  category  String      // Category at the time of assignment
  
  createdAt DateTime    @default(now())

  @@unique([sessionId, mcqId])
  @@index([sessionId, order])
}

model SessionAnswer {
  id        String      @id @default(uuid())
  sessionId String
  session   ExamSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  mcqId     String
  answer    String
  isCorrect Boolean
  category  String      // Category of the question
  
  createdAt DateTime    @default(now())

  @@unique([sessionId, mcqId])
}

model UserDetails {
  id               String   @id @default(uuid())
  userId           String   @unique
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  firstName        String
  lastName         String
  phoneNumber      String
  gender           String
  state            String
  city             String
  dateOfBirth      String
  teamLead         String
  language         String
  processAllocated String
  designation      String
  address          String
  consent          Boolean
  updatedAt        DateTime @updatedAt
}

model AssessmentResult {
  id             String   @id @default(uuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  process        String
  score          Float
  correctAnswers Int
  wrongAnswers   Int
  totalQuestions Int
  answers        Json // Stores { questionId: selectedOption }
  percentage     Float
  status         String // e.g., "COMPLETED", "FAILED", "PASSED"
  createdAt      DateTime @default(now())

  @@index([userId])
}

model Mcq {
  id            String             @id @default(uuid())
  question      String
  type          String             @default("MCQ")
  options       Json?
  correctAnswer String?
  option_a      String?
  option_b      String?
  option_c      String?
  option_d      String?
  correctOption String?
  process       String?
  category      String?
  module        String?
  role          String?            @default("BOTH")
  sourceFile    String?
  createdAt     DateTime           @default(now())
  assignedBy    AssignedQuestion[]
  sessions      SessionQuestion[]

  @@map("mcqs")
}

model AssignedQuestion {
  id         String   @id @default(uuid())
  userId     String
  mcqId      String
  assignedBy String?
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  mcq  Mcq  @relation(fields: [mcqId], references: [id], onDelete: Cascade)

  @@unique([userId, mcqId])
  @@index([userId])
  @@index([mcqId])
}
