name: Sync source repo to target

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
    
    steps:
      - name: Checkout source repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Push to target repository
        env:
          TARGET_TOKEN: ${{ secrets.TARGET_REPO_TOKEN }}
        run: |
          # Safety check
          if [ -z "${TARGET_TOKEN}" ]; then
            echo "‚ùå ERROR: TARGET_REPO_TOKEN secret is not set"
            exit 1
          fi
          
          echo "‚úÖ TARGET_REPO_TOKEN is set"
          
          # Target repository details
          TARGET_OWNER="Abhishek-John-Vision-Plus"
          TARGET_REPO="vision-plus"
          
          # Configure git credential helper to use the token
          git config --global credential.helper store
          echo "https://oauth2:${TARGET_TOKEN}@github.com" > ~/.git-credentials
          
          # Alternative: use username in URL (try both methods)
          # Method 1: Using oauth2 prefix
          git remote remove target 2>/dev/null || true
          git remote add target "https://oauth2:${TARGET_TOKEN}@github.com/${TARGET_OWNER}/${TARGET_REPO}.git"
          
          # Show what we're pushing
          echo "üì§ Pushing to ${TARGET_OWNER}/${TARGET_REPO}..."
          git log --oneline -5
          
          # Push with verbose output for debugging
          echo "Attempting to push main branch..."
          if git push target main --force --verbose; then
            echo "‚úÖ Successfully pushed main branch"
          else
            echo "‚ùå Push failed. Trying alternative authentication method..."
            
            # Method 2: Try with x-access-token prefix
            git remote remove target
            git remote add target "https://x-access-token:${TARGET_TOKEN}@github.com/${TARGET_OWNER}/${TARGET_REPO}.git"
            
            if git push target main --force --verbose; then
              echo "‚úÖ Successfully pushed main branch (alternative method)"
            else
              echo "‚ùå Both methods failed"
              exit 1
            fi
          fi
          
          # Push tags
          if git push target --tags --force 2>/dev/null; then
            echo "‚úÖ Successfully pushed tags"
          else
            echo "‚ö†Ô∏è  No tags to push or push failed"
          fi
          
          # Cleanup credentials
          rm -f ~/.git-credentials
          
          echo ""
          echo "üéâ Successfully synced to target repository!"
          echo "   Source: vision-limited/vision_plus_website"
          echo "   Target: ${TARGET_OWNER}/${TARGET_REPO}"
```

### Step 3: Verify Token Permissions

Make sure your Personal Access Token has:

**For Classic Token:**
- ‚úÖ `repo` (full control)
  - repo:status
  - repo_deployment  
  - public_repo
  - repo:invite
  - security_events

**For Fine-Grained Token:**
- ‚úÖ Contents: **Read and write**
- ‚úÖ Metadata: **Read-only**

### Step 4: Double-Check Repository Name

Verify the exact repository name at:
```
https://github.com/Abhishek-John-Vision-Plus/vision-plus
//repo name is vision-plus