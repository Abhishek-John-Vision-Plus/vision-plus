name: CD - Deploy to Production

on:
  push:
    branches: [main]

jobs:
  backup:
    name: ðŸ’¾ Database Backup
    runs-on: ubuntu-latest
    steps:
      - name: Create backup before deployment
        run: |
          ssh ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} \
            "docker exec postgres pg_dump -U postgres -d appdb > /backups/backup_$(date +%Y%m%d).sql"

  deploy-production:
    name: ðŸš€ Deploy to Production
    needs: backup
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://yourdomain.com
    
    steps:
      - uses: actions/checkout@v4
      
      - name: ðŸ”‘ Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PRODUCTION_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.PRODUCTION_HOST }} >> ~/.ssh/known_hosts

      - name: ðŸš€ Zero-downtime Deploy
        run: |
          ssh ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} << 'EOF'
            # Pull new image
            docker pull ghcr.io/${{ github.repository }}:${{ github.sha }}
            
            # Start new container on different port
            docker run -d --name app-new -p 3001:3000 \
              -e DATABASE_URL="${{ secrets.PRODUCTION_DATABASE_URL }}" \
              ghcr.io/${{ github.repository }}:${{ github.sha }}
            
            # Wait for health check
            sleep 10
            curl -f http://localhost:3001/api/health || exit 1
            
            # Switch traffic
            docker stop app-production || true
            docker rm app-production || true
            docker rename app-new app-production
          EOF

  notify:
    name: ðŸ“§ Notify
    needs: deploy-production
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "text": "${{ needs.deploy-production.result == 'success' && 'ðŸŽ‰' || 'ðŸš¨' }} Production deployment ${{ needs.deploy-production.result }}"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}